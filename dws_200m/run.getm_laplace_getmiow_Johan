#!/bin/sh

# time format: "yyyy-mm-dd hh:mi:ss"
# ex. "2001-12-02 00:00:00"

echo "run.getm"
hostname

echo "modelname=$modelname"
/bin/rm -f .getm.run.exit

start_time=$1
stop_time=$2
#if [ -z "$ref_start_time" ] ; then
# ref_start_time=$start_time
#fi

echo "ref_start: $ref_start_time"
echo "start: "$1
echo "stop:  "$2

echo "configuration: " $_CONFIGURATION_

#mpirun=/opt/mpich/bin/mpirun
#mpi_args="-machinefile machinefile"
#mpi_args="-machinefile machinefile -nolocal"
#mpich2_args="-machinefile machinefile"

# mpi on deepgreen
if [ $MPI == MPICH2 ]; then
   mpi_args="-envlist _CONFIGURATION_ -f machinefile -l"
elif [ $MPI == OPENMPI ]; then
#   mpi_args="-x LD_LIBRARY_PATH -x _CONFIGURATION_ --hostfile machinefile"
#   mpi_args="-x LD_LIBRARY_PATH -x _CONFIGURATION_ --bynode --bind-to-core --hostfile machinefile"
#   mpi_args="-x LD_LIBRARY_PATH --bind-to core --hostfile machinefile"
#   mpi_args="-x LD_LIBRARY_PATH -x _CONFIGURATION_ --bynode --hostfile machinefile"
#   mpi_args="-x LD_LIBRARY_PATH --novm --map-by core --bind-to core --cpus-per-proc 1 --report-bindings --hostfile machinefile"
#   mpi_args="-x LD_LIBRARY_PATH --oversubscribe --hostfile machinefile"
   export GFORTRAN_UNBUFFERED_PRECONNECTED='y' # make sure that output to .stderr is unbuffered
   mpi_args="-x LD_LIBRARY_PATH -x GFORTRAN_UNBUFFERED_PRECONNECTED --bind-to core --hostfile machinefile"
fi

#NMLDIR=$HOME/getm-setups/v1.6.x/nml
#NMLDIR=$HOME/getm-setups/v1.8.x/nml
#GETM_NAMELIST=$NMLDIR/getm.namelist
#GETM_PROTO=$NMLDIR/getm.proto

np=`head -1 par_setup.dat`

echo "removing old output and old output hot start files"
#echo $PDSH
#echo $PDSH "rm -f $out_dir/restart.???.out"
#which pdsh
#ls /usr/bin/pdsh
#hostname
#$PDSH "rm -f $out_dir/restart.???.out"
#$PDSH "rm -f $out_dir/*.nc"
rm -f $out_dir/restart.????.out
sleep 5
wait
rm -f $out_dir/*.nc
sleep 5
#sleep $sleepsecs
wait
echo "done"

#$PDSH "ls $hot_dir/"
ls $hot_dir/
echo "removing old input hot start files"
echo "Never mind messages that file is not found: it does get done"
#$PDSH "rm -f $hot_dir/restart.???.in"
#rm -f $hot_dir/restart.????.in
ip=0
while [ $ip -le $nprocesses ]; do
  if [ $ip -lt 10 ]; then
    ipn="000"$ip
  elif [ $ip -lt 100 ]; then
    ipn="00"$ip
  elif [ $ip -lt 1000 ]; then
    ipn="0"$ip
  else 
    ipn=$ip
  fi
  echo $ipn
  echo $hot_dir
  ls -la $hot_dir/restart.$ipn.in
  rm -f $hot_dir/restart.$ipn.in
  sleep 0.1
  wait
  let ip=ip+1
done
wait
#sleep $sleepsecs
echo "done"

echo "making getm.inp"
#$GETM_NAMELIST 		\
#	--proto $GETM_PROTO --conf north_west_european_shelf.conf --namelist getm.inp \
#        runid=\"$runid\"		\
#        runtype=$runtype		\
#        hotstart=$hotstart		\
#        use_epoch=$use_epoch		\
#        start="\"$start_time\""		\
#        stop="\"$stop_time\""		\
#        metforcing=$metforcing		\
#        river_method=$river_method	\
#        An=$An				\
#        bdy2d=$bdy2d			\
#        bdyramp_2d=$bdyramp_2d		\
#        bdy3d=$bdy3d			\
#        temp_method=$temp_method	\
#        salt_method=$salt_method	\
#        step_2d=$step_2d                \
#        step_3d=$step_3d                \
#        out_dir=\"$out_dir\"
echo "metforcing" $metforcing
#editscenario.py -e nml --schemadir=/home/$USER/$GETMDIR/schemas $runid.xml .
export start=$ref_start_time
export stop=$stop_time
#/home/jv02/bin/editscenario.py -e nml --skipvalidation --schemadir=/home/jv02/GETM_SOURCES/getm-git/schemas north_west_european_shelf.xml .
#export GOTMGUIDIR=$HOME/GOTM_SOURCES/gotm-git/gui.py
export GOTMGUIDIR=$HOME/home/GOTM_SOURCES/gotm-git/gui.py
#JM not sure if this is needed #export GOTMDIR=$HOME/gotm
#$HOME/bin/editscenario.py -e nml --skipvalidation --schemadir=$HOME/GETM_SOURCES/getm-git/schemas north_west_european_shelf.xml .

# getm_2.2.2
#$HOME/bin/editscenario.py -e nml --skipvalidation --schemadir=/fs3/jvandermolen/GETM_SOURCES/getm-git/schemas north_west_european_shelf.xml .

# getm_git: master, iow_master (and les and ip branches)
$HOME/tools/bbpy/editscenario/editscenario/editscenario.py -q -e nml . --schemadir=/export/lv1/user/jvandermolen/home/getm-git/code/schemas --targetversion=getm-2.5 north_west_european_shelf.xml

echo "done"


date
echo "start running the model...."
t1=`date +%s`
#$mpirun $mpi_args -np $np bin/getm_prod_IFORT.$conf &> $logdir/log.run
#  mpdtrace -l
echo "  mpiexec -l $mpich2_args -n $np bin/getm_prod_IFORT13.$conf &> $logdir/log.run"
#  mpiexec -l $mpich2_args -n $np bin/getm_prod_IFORT13.$conf &> $logdir/log.run
#  mpiexec $mpi_args -np $np  /home/jv02/CEFAS/setups/north_west_european_shelf/bin/getm_prod_$FORTRAN_COMPILER.$conf &> $logdir/log.run
#  mpiexec $mpi_args -np $np /gpfs/env/dtc13fpu/GETM_ERSEM_SETUPS/north_west_european_shelf/bin/getm_prod_$FORTRAN_COMPILER.$conf &> $logdir/log.run
  mpirun $mpi_args -np $np $HOME/home/GETM_ERSEM_SETUPS/north_west_european_shelf/bin/getm_prod_$FORTRAN_COMPILER.$conf &> $logdir/log.run
t2=`date +%s`
echo "... we made it"


#echo $t2-$t1 > $$.tmp
#wall=`bc < $$.tmp`
#rm -f $$.tmp
#echo "wall clock time: "$wall" secs"
#echo "wall clock time: "$wall" secs" >>  $logdir/log.run 2>&1

echo "moving hot start files"
#$PDSH rm -f $hot_dir/restart.\*.in
#$PDSH mmv "$out_dir/restart.\*.out" $hot_dir/restart.\#1.in

# alternative move method to make sure that hotstart files are moved
#let ii=$firstnode-1
#while [ $ii -lt $lastnode ] ; do
#  let i1=ii+1
#  if [ $i1 -lt 10 ] ; then
#    inode="n0"$i1
#  else
#    inode="n"$i1
#  fi
#  echo "inode "$inode
#  echo "out_dir " $out_dir " hot_dir " $hot_dir
#  ssh $inode mmv -o "$out_dir/restart.\*.out" $hot_dir/restart.\#1.in
#  wait
#  sleep 1
#  echo "mmv status: "$?
#  let ii=$i1
#mmv -o "$out_dir/restart.\*.out" $hot_dir/restart.\#1.in
#done
#mv "$out_dir/restart.\*.out" $hot_dir/restart.\#1.in
#mmv -o "$out_dir/restart.*.out" $hot_dir/restart.#1.in
echo "moving restart files, hot_dir:",$hot_dir
#      mmv -o "$out_dir/restart.*.out" $hot_dir/restart.#1.in
      mv -f $out_dir/*.out $hot_dir/.
      wait
      rename .out .in $hot_dir/*.out
      wait
      sleep 1
#      rm -f $out_dir/restart.???.out
      echo "done"

wait

echo "done"

echo "moving log files"
mv *.stderr getm.inp $logdir && rm -f *.stdout
wait
echo "done"

#nice -n 19 ./move_files &
#./move_files_qsub
#nice -n 19 ./move_files_selected_tiles &
#./move_files_selected_tiles_qsub
#qsub -v out_dir=$out_dir,runid=$runid ./move_files_qsub_single
#bsub -q cefas-seq -J "move_files_grace" -n 1 -o 'move_files.stdout' "sh ./move_files_grace $out_dir $runid "
ssh_string='nice -n 10 '`pwd`'/move_files '$out_dir' '$runid' > ~/err_move_files.msg &'
echo $ssh_string
ssh no60 "$ssh_string" > ~/err_sshm01.msg &
sleep 1

rm .info.pid
pid=$!
echo "$out_dir $coldir $pid" >> .info.pid


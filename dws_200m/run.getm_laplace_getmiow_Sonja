#!/bin/sh

# time format: "yyyy-mm-dd hh:mi:ss"
# ex. "2001-12-02 00:00:00"

echo "run.getm"
hostname

setup="dws_200m"

echo "modelname=$modelname"
/bin/rm -f .getm.run.exit

start_time=$1
stop_time=$2


echo "ref_start: $ref_start_time"
echo "start: "$1
echo "stop:  "$2

echo "configuration: " $_CONFIGURATION_


# mpi on deepgreen
if [ $MPI == MPICH2 ]; then
   mpi_args="-envlist _CONFIGURATION_ -f machinefile -l"
elif [ $MPI == OPENMPI ]; then
   # make sure that output to .stderr is unbuffered
   export GFORTRAN_UNBUFFERED_ALL=y
   export GFORTRAN_UNBUFFERED_PRECONNECTED=y 
   mpi_args="-x LD_LIBRARY_PATH -x GFORTRAN_UNBUFFERED_ALL -x GFORTRAN_UNBUFFERED_PRECONNECTED --bind-to core --hostfile machinefile"
fi


np=`head -1 par_setup.dat`

echo "removing old output and old output hot start files"
rm -f $out_dir/restart.????.out
sleep 5
wait
rm -f $out_dir/*.nc
sleep 5
wait
echo "done"

#ls $hot_dir/
echo "removing old input hot start files"
echo "Never mind messages that file is not found: it does get done"

ip=0
while [ $ip -le $nprocesses ]; do
  if [ $ip -lt 10 ]; then
    ipn="000"$ip
  elif [ $ip -lt 100 ]; then
    ipn="00"$ip
  elif [ $ip -lt 1000 ]; then
    ipn="0"$ip
  else 
    ipn=$ip
  fi
  #if [$ip -lt 2]; then
  echo $ipn
  echo $hot_dir 
  #fi
  #ls -la $hot_dir/restart.$ipn.in
  rm -f $hot_dir/restart.$ipn.in
  sleep 0.1
  wait
  let ip=ip+1
done
wait
#sleep $sleepsecs
echo "done"

echo "making getm.inp"
echo "metforcing" $metforcing

export start=$ref_start_time
export stop=$stop_time
export GOTMGUIDIR=$HOME/home/GOTM_SOURCES/gotm-git/gui.py

# getm_git: master, iow_master (and les and ip branches)
$HOME/tools/bbpy/editscenario/editscenario/editscenario.py -q -e nml . --schemadir=/$HOME/home/getm-git/schemas --targetversion=getm-2.5 $setup.xml

echo "done"


date
echo "start running the model...."
t1=`date +%s`
echo "  mpiexec -l $mpich2_args -n $np bin/getm_prod_IFORT13.$conf &> $logdir/log.run"

  mpirun $mpi_args -np $np $HOME/home/GETM_ERSEM_SETUPS/$setup/bin/getm_prod_$FORTRAN_COMPILER.$conf &> $logdir/log.run

t2=`date +%s`
echo "... we made it"

echo "starting move_files"

#sleep 1
# use queue:
# for generating boundary conditions or merged subsets via run_all comment this out
sbatch ./move_files $out_dir $runid

echo "moving hot start files"
echo "moving restart files, hot_dir:",$hot_dir
#      mmv -o "$out_dir/restart.*.out" $hot_dir/restart.#1.in
      sleep 10
      mv -f $out_dir/*.out $hot_dir/.
      wait
      rename .out .in $hot_dir/*.out
      wait
      sleep 10
#      rm -f $out_dir/restart.???.out
      echo "done"

wait

echo "done"

echo "moving log files"
rsync -a *.stderr $logdir/.
cp getm.inp $logdir/.
#rm -f *.stderr
#rm -f *.stdout
rm getm.inp
#rm stderr.tgz
wait
echo "done"

rm .info.pid
pid=$!
echo "$out_dir $coldir $pid" >> .info.pid


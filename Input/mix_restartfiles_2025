#!/bin/bash

# combines two restart files:
# an early one (taking the physics)
# a later one (taking the biology)

#-----Settings---------------------------------------------------

# indir_phys=/export/lv1/user/jvandermolen/home/GETM_ERSEM_SETUPS/north_sea_coarse_noos_bfm2016_jan2025/restart_1981_01/
indir_phys=/export/lv9/user/qzhan/home/GETM_ERSEM_SETUPS/model_input_files/restart/
fname_phys=restart_201501_hydro_reducedlayers.nc
indir_bio=$indir_phys
fname_bio=restart_201501_bio_reducedlayers.nc
outdir=$indir_phys
outfname=restart_dws200_2015_01.nc

tempsalt_from_phys=1
spm_from_phys=0

#----------------------------------------------------------------

echo "mix_restartfiles"

# first clean up
rm $outdir/$outfname
rm $outdir/temp1.nc
rm $outdir/temp2.nc
rm $outdir/temp_bio.nc
rm $outdir/temp_phys.nc
rm $outdir/temp_out1.nc
rm $outdir/temp_out2.nc
rm $outdir/temp_slice1.nc
rm $outdir/temp_slice2.nc
rm $outdir/temp_combined.nc
rm $outdir/temp_combined1.nc

# copy bio file
#echo "copying bio file..."
#cp   $outdir/temp1.nc #$outfname
#cp $indir_bio/$fname_bio $outdir/$outfname

## remove obsolete variables
##ncks -C -O -x -v Uinto $outdir/temp1.nc $outdir/temp2.nc
##ncks -C -O -x -v Vinto $outdir/temp2.nc $outdir/$outfname

# fix bio file so it has the same spatial dimensions as the hydro file
# ncks --no-abc -d xax,-5.6552,16.5291 $indir_bio/$fname_bio $outdir/temp1.nc
# ncks --no-abc -d yax,48.2,60.0 $outdir/temp1.nc $outdir/temp_bio.nc

# also cut a row off the hydro file
# ncks --no-abc -d yax,48.1,60.0 $indir_phys/$fname_phys $outdir/temp_phys.nc

#!!!JM this now results in a file that has overlapping bio and phys.
#!!!and gets read in the same way
#!!!but still need to add a row to the bottom as value are shifted.


# start with original physics file
cp $indir_phys/$fname_phys $outdir/temp_phys.nc
cp $indir_bio/$fname_bio $outdir/temp_bio.nc

# start with time
echo "adding time"
ncks --no-abc -C -A -v loop,julianday,secondsofday,timestep $indir_phys/$fname_phys $outdir/$outfname

# add axes from hydro
# for some reason or other adding this results in an unreadable hotstart file
#ncks --no-abc -C -A -v xax,yax,zax $outdir/temp_phys.nc $outdir/$outfname

# add physics
echo "adding physics variables..."
ncks --no-abc -C -A -v z,zo,U,SlUx,Slru,V,SlVx,Slrv,ssen,ssun,ssvn,sseo,ssuo,ssvo,Uint,Vint,Uadv,Vadv,uu,vv,ww,uuEx,vvEx,tke,eps,num,nuh,ho,hn $outdir/temp_phys.nc $outdir/$outfname

if [ $tempsalt_from_phys -eq 1 ]
then
  echo "replacing temp and salt..."
  ncks --no-abc -C -A -v T,S $outdir/temp_phys.nc $outdir/$outfname
fi
if [ $spm_from_phys -eq 1 ]
then
  echo "replacing spm..."
  ncks --no-abc -C -A -v R9x $outdir/temp_phys.nc $outdir/$outfname
fi

# add bio
echo "adding biological variables"
ncks --no-abc -C -A -v numc,numbc,start_3d,start_2d $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v R9x,O2o,N1p,N3n,N4n,N5s,N6r,B1c,B1n,B1p,Bac $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v P1c,P1n,P1p,P1l,P1s,P2c,P2n,P2p,P2l,P3c,P3n,P3p,P3l $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v P4c,P4n,P4p,P4l,P5c,P5n,P5p,P5l,P5s,P6c,P6n,P6p,P6l,Pcc $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v R1c,R1n,R1p,R2c,R2n,R3c,R6c,R6n,R6p,R6s,RZc,O3c,O3h $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v Z3c,Z4c,Z2c,Z5c,Z6c,BP1c,BP1n,BP1p,BP1l,BP1s $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v Y1c,Y1n,Y1p,Y2c,Y2n,Y2p,Y4c,Y4n,Y4p,Y5c,Y5n,Y5p $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v Yy3c,Yy3n,Yy3p,Y3c,Y3n,Y3p,Ys3c,Q6c,Q6n,Q6p,Q6s $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v Q9x,Qp9x,QSx,Qun,Q1un,Q2un,Q2c,Q2n,Q12c,Q12n,Q1c,Q1n,Q1p $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v Q11c,Q11n,Q11p,Q21c,Q21n,Q21p,H1c,H1n,H1p,H2c,H2n,H2p $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v H3c,H3n,H3p,HNc,HNn,HNp,Hac,Kp1p,Kp3n,Kp4n,Kn4n,Kp5s $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v Qpun,K1p,K11p,K21p,K4n,K14n,K24n,K5s,K15s,K6r,K16r,K26r,K3n $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v K13n,K23n,G2o,G4n,Dfm,Dcm,Dlm,D1m,D2m,D6m,D7m,D8m,D9m,DSm $outdir/temp_bio.nc $outdir/$outfname
ncks --no-abc -C -A -v DH2m,DH3m,irri_bio,G3c,G3h,G13c,G13h,G23c,G23h,Mcac,Mcan,Mcap,Mcal,Msc $outdir/temp_bio.nc $outdir/$outfname

# add a row at the bottom
# first copy the bottom row to a file
# ncks --no-abc -O -d yax,1 $outdir/$outfname $outdir/temp_slice.nc
# then stick it to the output file
# then combine
# ncrename -h -d yax,time $outdir/temp_slice.nc                                       #rename dimension
# ncpdq -O -a time,xax,zax $outdir/temp_slice.nc $outdir/temp_slice1.nc               #move time dimension to front
# ncks --no-abc -O --mk_rec_dmn time $outdir/temp_slice1.nc $outdir/temp_slice2.nc    # make it the record dimension
# ncrename -h -d yax,time $outdir/$outfname                                           # do the same for the file produced so far
# ncpdq -O -a time,xax,zax $outdir/$outfname $outdir/temp_out1.nc
# ncks --no-abc -O --mk_rec_dmn time $outdir/temp_out1.nc $outdir/temp_out2.nc
# ncrcat -O $outdir/temp_slice2.nc $outdir/temp_out2.nc $outdir/temp_combined.nc      # combine along new 'time' dimension
# ncrename -h -d time,yax $outdir/temp_combined.nc                                    # rename back
# ncpdq -O -a zax,yax,xax $outdir/temp_combined.nc $outdir/temp_combined1.nc                                   # put order back
# now zax is the record dimension, not sure how to downgrade that, maybe not needed.

# rm $outdir/$outfname
# wait
# mv $outdir/temp_combined1.nc $outdir/$outfname

# fix time
echo "fixing time..."
ncks -A -v julianday $indir_phys/$fname_phys $outdir/$outfname
#this is done as part of the previous command:
#ncks -C -A -a restart_date $indir_phys/$fname_phys $outdir/$outfname

echo "done!"

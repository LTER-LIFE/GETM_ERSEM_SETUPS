---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(terra)
library(ncdf4)
library(ggplot2)
library(tidyterra)

library(terra)
library(leaflet)

ncfile_path <- "C:/Users/qzhan/OneDrive - NIOZ/Attachments/01_LTER-LIFE/03_Model/3D_models_WaddenSea/Input/"

# --- Load topo (to get grid and Wadden island mask) ---
nc_topo <- nc_open(paste0(ncfile_path, "topo_adjusted_dws_200m_2009.nc"))
lonc <- ncvar_get(nc_topo, "lonc")
latc <- ncvar_get(nc_topo, "latc")
bathy <- ncvar_get(nc_topo, "bathymetry")
nc_close(nc_topo)

dim_xc <- dim(lonc)[1]
dim_yc <- dim(lonc)[2]

# Wadden island mask: TRUE = island (NA in topo)
island_mask <- is.na(bathy)

# --- Load Wadden Sea measurements ---
silt_nc <- rast(paste0(ncfile_path, "sediment_mud_fraction.nc"))

# Assign CRS (assume lon/lat, EPSG:4326)
if (crs(silt_nc) == "") crs(silt_nc) <- "EPSG:4326"

# Replace negative values with NA
silt_nc[silt_nc < 0] <- NA

# --- Load North Sea porosity ---
ns_nc <- rast(paste0(ncfile_path, "Ben_Sedprop.nc"))
crs(ns_nc)
ns_ll <- project(ns_nc, "EPSG:4326")  # reproject to lon/lat if needed

# --- Prepare target coordinates for GETM grid ---
xy <- cbind(as.vector(lonc), as.vector(latc))  # N x 2

```


# Functions
## Prepare interactive leaflet map function
```{r}
library(terra)
library(leaflet)

plot_interactive <- function(arr, lonc, latc, title="Raster Map") {
  # Convert array to points
  df <- data.frame(
    lon = as.vector(lonc),
    lat = as.vector(latc),
    value = as.vector(arr)
  )
  
  # Remove missing for plotting
  df <- df[!is.na(df$value), ]
  
  # Color palette
  pal <- colorNumeric("viridis", df$value, na.color="grey80")
  
  leaflet(df) %>%
    addTiles() %>%
    addCircleMarkers(
      lng = ~lon, lat = ~lat,
      radius = 2,
      color = ~pal(value),
      stroke = FALSE, fillOpacity = 0.8,
      label = ~paste0(round(value,4))
    ) %>%
    addLegend(
      pal = pal,
      values = df$value,
      title = title
    )
}

```

# 1. Load Wadden Sea porosity map
```{r}

library(classInt)
library(leaflet)

silt_nc <- rast(paste0(ncfile_path, "sediment_mud_fraction.nc"))

# Assign CRS (assume lon/lat, EPSG:4326)
if (crs(silt_nc) == "") crs(silt_nc) <- "EPSG:4326"

# Replace negative values with NA
silt_nc[silt_nc < 0] <- NA

# Optional: interactive map for Wadden Sea porosity
df_ws <- as.data.frame(silt_nc, xy = TRUE)
df_ws <- df_ws[,c("lonc","latc","mud_fraction","porosity")]
names(df_ws) <- c("lon","lat", "Silt_content","porosity")
df_ws <- df_ws[!is.na(df_ws$porosity), ]

# small value in gully account for a mall contribution
plot(density(df_ws$Silt_content))

# Franken et al. used a 5-class quantile categorical color scale, not a continuous viridis scale.
# A discrete ramp that emphasizes structural contrasts
# Often based on earth tones (brown–yellow–blue) or GIST-Earth / terrain
# A hillshade underneath enhances gullies regardless of palette


# pal_ws_silt <- colorNumeric("viridis", df_ws$Silt_content, na.color="grey80")
# pal_ws <- colorNumeric("viridis", df_ws$porosity, na.color="grey80")

# define quantile breaks
silt_brks <- classInt::classIntervals(df_ws$Silt_content, n = 5, style = "quantile")$brks
por_brks <- classInt::classIntervals(df_ws$porosity, n = 5, style = "quantile")$brks

# pick 5 colors (low→high), e.g. from brown → green → blue
col5 <- c("#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598")

pal_ws_silt <- colorBin(palette = col5,
                       bins = silt_brks,
                       domain = df_ws$Silt_content,
                       na.color = "transparent",
                       right = TRUE)

pal_ws_por <- colorBin(palette = col5,
                     bins = por_brks,
                     domain = df_ws$porosity,
                     na.color = "transparent",
                     right = TRUE)

# Silt content map from Franken et al.,
leaflet(df_ws) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 3,
    color = ~pal_ws_silt(Silt_content),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("Silt content: ", round(Silt_content, 2), "%")
  ) %>%
  addLegend(
    pal = pal_ws_silt,
    values = df_ws$Silt_content,
    title = "Wadden Sea Silt content (%)"
  )


# Porosity
leaflet(df_ws) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 3,
    color = ~pal_ws_por(porosity),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("Porosity: ", round(porosity,4))
  ) %>%
  addLegend(
    pal = pal_ws_por,
    values = df_ws$porosity,
    title = "Porosity (quantile classes)"
  )



```
The range of Wadden Sea porosity based on SIBES & SUBES dataset: 0.3878324 0.6755730


# 2. Load Default North Sea porosity raster
```{r}
ns_por <- rast(paste0(ncfile_path, "Ben_Sedprop.nc"))

# Reproject to EPSG:4326 if needed
if (crs(ns_por) != "EPSG:4326") {
  ns_por <- project(ns_por, "EPSG:4326")
}

# Optional: interactive map for NS porosity
df_ns <- as.data.frame(ns_por, xy = TRUE)
df_ns <- df_ns[,c("x", "y", "Porosity")]
names(df_ns) <- c("lon","lat","porosity")
df_ns <- df_ns[!is.na(df_ns$porosity), ]

pal_ns <- colorNumeric("viridis", df_ns$porosity, na.color="grey80")

leaflet(df_ns) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 2,
    color = ~pal_ns(porosity),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("Porosity: ", round(porosity,4))
  ) %>%
  addLegend(
    pal = pal_ns,
    values = df_ns$porosity,
    title = "North Sea Porosity"
  )


range(df_ns$porosity)
```
The range of default Northsea & Wadden Sea porosity: 0.4011450 0.5160929


# 2.1. Interpolate NS porosity to GETM grid ---
```{r echo=TRUE}
# ------------------------------
# Prepare target GETM coordinates for interpolation
# ------------------------------
xy <- cbind(as.vector(lonc), as.vector(latc))  # N x 2

# Interpolate NS porosity to GETM grid
# ns_vals <- terra::extract(ns_por, xy, method="bilinear")
ns_vals <- terra::extract(ns_por, xy, method="simple")
ns_vals <- ns_vals$Porosity
if(is.data.frame(ns_vals)) ns_vals <- ns_vals[, ncol(ns_vals)]
ns_arr <- array(as.numeric(ns_vals), dim = c(dim_xc, dim_yc))

ns_arr[island_mask] <- NA

# Optional: interactive inspection
df_ns_interp <- data.frame(
  lon = as.vector(lonc),
  lat = as.vector(latc),
  porosity = as.vector(ns_arr)
)
df_ns_interp <- df_ns_interp[!is.na(df_ns_interp$porosity), ]
pal_ns_interp <- colorNumeric("viridis", df_ns_interp$porosity, na.color="grey80")

leaflet(df_ns_interp) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 2,
    color = ~pal_ns_interp(porosity),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("Porosity: ", round(porosity,4))
  ) %>%
  addLegend(
    pal = pal_ns_interp,
    values = df_ns_interp$porosity,
    title = "NS Porosity Interpolated (200m)"
  )
```

# 2.1.1. Interpolate NS porosity with fixed value ---
```{r echo=TRUE}

xy <- cbind(as.vector(lonc), as.vector(latc))  # N x 2

# Interpolate NS porosity to GETM grid
# ns_vals <- terra::extract(ns_por, xy, method="bilinear")
ns_vals <- terra::extract(ns_por, xy, method="simple")
ns_vals <- ns_vals$Porosity

# set all values (non-missing values) to north sea value: 0.4011
ns_vals[!is.na(ns_vals)] <- 0.4011

ns_arr <- array(ns_vals, dim = c(dim_xc, dim_yc))

# Optional: interactive inspection
df_ns_interp <- data.frame(
  lon = as.vector(lonc),
  lat = as.vector(latc),
  porosity = as.vector(ns_arr)
)
df_ns_interp <- df_ns_interp[!is.na(df_ns_interp$porosity), ]
pal_ns_interp <- colorNumeric("viridis", df_ns_interp$porosity, na.color="grey80")

leaflet(df_ns_interp) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 2,
    color = ~pal_ns_interp(porosity),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("Porosity: ", round(porosity,4))
  ) %>%
  addLegend(
    pal = pal_ns_interp,
    values = df_ns_interp$porosity,
    title = "NS Porosity Interpolated (200m)"
  )

```

# 2.2. Merge: replace NS porosity with Wadden Sea values
```{r}


df_ws_grid <- as.data.frame(silt_nc)
df_ws_grid <- df_ws_grid[,c("lonc", "latc", "porosity")]
names(df_ws_grid) <- c("lon", "lat", "porosity")

ws_arr <- as.array(df_ws_grid$porosity, dim = c(dim_xc, dim_yc))  # should already be dim_xc x dim_yc

final_porosity <- ns_arr
final_porosity[!is.na(ws_arr)] <- ws_arr[!is.na(ws_arr)]

# Optional: interactive inspection
df_ns_ws_merg <- data.frame(
  lon = as.vector(lonc),
  lat = as.vector(latc),
  porosity = as.vector(final_porosity)
)

df_ns_ws_merg <- df_ns_ws_merg[!is.na(df_ns_ws_merg$porosity), ]

# use wadden sea data for defining breaks, otherwise north sea will create repeat breaks (large nr)
por_brks <- classInt::classIntervals(df_ws$porosity, n = 5, style = "quantile")$brks

# pick 5 colors (low→high), e.g. from brown → green → blue
col5 <- c("#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598")

pal_ws_por_merg <- colorBin(palette = col5,
                            bins = por_brks,
                            domain = df_ns_ws_merg$porosity,
                            na.color = "transparent",
                            right = TRUE)

# pal_ns_interp <- colorNumeric("viridis", df_ns_ws_merg$porosity, na.color="grey80")

leaflet(df_ns_ws_merg) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 3,
    color = ~pal_ws_por_merg(porosity),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("sediment porosity: ", round(porosity, 3))
  ) %>%
  addLegend(
    pal = pal_ws_por_merg,
    values = df_ns_ws_merg$porosity,
    title = "NS Porosity replaced with Wadden Sea 200m"
  )

```
# 2.3 Apply Wadden island mask
```{r}

final_porosity <- ns_arr
final_porosity[!is.na(ws_arr)] <- ws_arr[!is.na(ws_arr)]
final_porosity[island_mask] <- NA

# Optional: interactive inspection of final merged porosity
df_final <- data.frame(
  lon = as.vector(lonc),
  lat = as.vector(latc),
  porosity = as.vector(final_porosity)
)

df_final <- df_final[!is.na(df_final$porosity), ]

# pal_final <- colorNumeric("viridis", df_final$porosity, na.color="grey80")
# use wadden sea data for defining breaks, otherwise north sea will create repeat breaks (large nr)
por_brks <- classInt::classIntervals(df_ws$porosity, n = 5, style = "quantile")$brks

# pick 5 colors (low→high), e.g. from brown → green → blue
col5 <- c("#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598")

pal_ws_por_final <- colorBin(palette = col5,
                            bins = por_brks,
                            domain = df_final$porosity,
                            na.color = "transparent",
                            right = TRUE)


leaflet(df_final) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 3,
    color = ~pal_ws_por_final(porosity),
    stroke = FALSE, fillOpacity = 0.8,
    label = ~paste0("sediment porosity: ", round(porosity, 3))
  ) %>%
  addLegend(
    pal = pal_ws_por_final,
    values = df_final$porosity,
    title = "NS Porosity replaced with Wadden Sea 200m"
  )


```

# 2.4 Write NetCDF
```{r}

out_nc <- paste0(ncfile_path, "porosity_merged.nc")

xc_dim <- ncdim_def("xc", "m", 1:dim_xc)
yc_dim <- ncdim_def("yc", "m", 1:dim_yc)

lon_var <- ncvar_def("lonc", "degree_east", list(xc_dim, yc_dim), missval=1e20, prec="float")
lat_var <- ncvar_def("latc", "degree_north", list(xc_dim, yc_dim), missval=1e20, prec="float")
por_var <- ncvar_def("porosity", "1", list(xc_dim, yc_dim), missval=-999, prec="float")

ncnew <- nc_create(out_nc, vars = list(lon_var, lat_var, por_var))
ncvar_put(ncnew, "lonc", lonc)
ncvar_put(ncnew, "latc", latc)

# Replace NA with -999 for NetCDF
final_nc <- final_porosity
final_nc[is.na(final_nc)] <- -999
ncvar_put(ncnew, "porosity", final_nc)

ncatt_put(ncnew, 0, "type", "Merged Wadden Sea + North Sea porosity")
ncatt_put(ncnew, 0, "gridid", "North Sea and Wadden Sea")
ncatt_put(ncnew, 0, "history", paste("Created:", date()))
nc_close(ncnew)

cat("Final porosity NetCDF written to:", out_nc, "\n")

```

